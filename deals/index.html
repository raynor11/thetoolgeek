<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Tool Geek â€“ Deals</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 20px; }
    table.dataTable { width: 100% !important; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      h1 { font-size: 18px; }
      table.dataTable { font-size: 14px; }
    }
    .deal-thumb {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 6px;
    }
    .image-wrapper {
      display: inline-block;
      width: 64px;
      height: 64px;
    }
  </style>
</head>
<body>

<h1>The Tool Geek</h1>
<a href="../">Home</a> | <a href="../blogs">Blogs</a> | <a href="../vlogs">Vlogs</a> | <b>Deals</b>

<hr>

<table id="deals" class="display">
  <thead>
    <tr>
      <th>Image</th>
      <th>Title</th>
      <th>Store</th>
      <th>Price</th>
      <th>Category</th>
      <th>Posted</th>
    </tr>
  </thead>
</table>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function () {
  $('#deals').DataTable({
    responsive: true,
    ajax: {
      url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRq-VPRdhDsPPD7eK3Us645Fljcz_sm2ZiwZL448KvxjF4bKuTXS1o8KwKa5z05vK891GapoybIZPsm/pub?output=csv',
      dataType: 'text',
      dataSrc: function (csv) {
        // Proper CSV parsing that handles quoted fields with commas
        function parseCSVLine(line) {
          var result = [];
          var cell = '';
          var inQuotes = false;
          
          for (var i = 0; i < line.length; i++) {
            var char = line[i];
            var nextChar = line[i + 1];
            
            if (char === '"') {
              if (inQuotes && nextChar === '"') {
                // Escaped quote
                cell += '"';
                i++;
              } else {
                // Toggle quote state
                inQuotes = !inQuotes;
              }
            } else if (char === ',' && !inQuotes) {
              // End of cell - push the cell content (even if empty)
              result.push(cell);
              cell = '';
            } else {
              cell += char;
            }
          }
          // Push the last cell
          result.push(cell);
          
          // Trim all cells
          return result.map(function(c) { return c.trim(); });
        }
        
        // Normalize line endings to handle different CSV formats
        csv = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        var lines = csv.split('\n');
        var data = [];
        // Skip header row (index 0) and parse remaining rows
        for (var i = 1; i < lines.length; i++) {
          if (lines[i].trim() === '') continue;
          var row = parseCSVLine(lines[i]);
          data.push(row);
        }
        return data;
      }
    },
    columns: [
      {
        data: 0,
        orderable: false,
        render: (function() {
          // Constants defined once for efficiency
          var PLACEHOLDER_STYLE = 'width: 64px; height: 64px; background-color: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #999;';
          var PLACEHOLDER_HTML = '<div style="' + PLACEHOLDER_STYLE + '">No Image</div>';
          
          // Escape function for HTML attributes - defined once
          var escapeAttr = function(str) {
            return str.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&#039;');
          };
          
          // Error handler for broken images - defined once
          var handleImageError = function(img) {
            if (img.dataset.errorHandled) return; // Prevent duplicate execution
            img.dataset.errorHandled = 'true';
            img.style.display = 'none';
            
            // Check if parent element exists
            if (!img.parentElement) return;
            
            var placeholder = document.createElement('div');
            placeholder.style.cssText = PLACEHOLDER_STYLE;
            placeholder.textContent = 'No Image';
            img.parentElement.appendChild(placeholder);
          };
          
          // Store error handler globally for onerror to access (namespaced to avoid conflicts)
          window.toolGeekHandleDealImageError = handleImageError;
          
          return function(data, type, row) {
            if (type !== "display") return data;
            
            // Handle empty or missing image URL
            if (!data || data.trim() === '') {
              return PLACEHOLDER_HTML;
            }
            
            // Validate URL protocol to prevent XSS (javascript:, data:, etc.)
            var url = data.trim();
            if (!url.match(/^https?:\/\//i)) {
              return PLACEHOLDER_HTML;
            }
            
            var safeUrl = escapeAttr(url);
            var safeTitle = escapeAttr((row[1] || ""));
            
            // Use wrapper div with error handling via namespaced global function
            return '<div class="image-wrapper"><img class="deal-thumb" src="' + safeUrl + '" alt="' + safeTitle + '" loading="lazy" onerror="window.toolGeekHandleDealImageError(this)"></div>';
          };
        })()
      },
      { data: 1 }, // Title
      { data: 2 }, // Store
      { data: 3 }, // Price
      { data: 4 }, // Category
      { data: 6 }  // Posted
    ]
  });
});
</script>

</body>
</html>
